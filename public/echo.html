<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>ECHO</title>
	<link rel="stylesheet" href="/css/milligram.min.css"/>
	<style>
		body {
			width: 75%;
			margin: 100px auto 0;
		}
	</style>
</head>
<body>

<h1 id="header">Соединение устанавливается</h1>

<div id="wrapper" hidden="hidden">
	<label for="text">Введите сообщение</label>
	<input type="text" id="text">
	<input type="button" id="send" value="Отправить">
	<ul id="messages"></ul>
</div>

<script>
	'use strict';

//	const host = 'ws:/' + location.host;

	console.log('Создаём новый WebSocket');
	const ws = new WebSocket('ws:/' + location.host + '/ws/echo');
//	const ws = new WebSocket('ws://cors.anotherhost.com/ws/echo');

	ws.onopen = function (event) {
		console.log(event);
		window.header.innerText = 'Соединено';
		window.wrapper.hidden = false;


		window.send.addEventListener('click', function (e) {
			e.preventDefault();
			const msg = window.text.value;
			window.text.value = '';
			ws.send(JSON.stringify({text: msg}));
		});

		ws.onmessage = function (event) {
			const incomingMessage = event.data;
			const message = JSON.parse(incomingMessage);
			window.messages.innerHTML += '<li></li>';
			window.messages.lastChild.innerText = message.text;
		};
	};

	ws.onclose = function (event) {
		if (event.wasClean) {
			console.log('Соединение закрыто чисто');
		} else {
			console.log('Обрыв соединения');
		}
		console.log('Код: ' + event.code + ' причина: ' + event.reason);
		window.header.innerText = 'Ошибка соединения';
		window.wrapper.hidden = true;
	};

	ws.onerror = function (error) {
		console.log('Ошибка ' + error.message);
	};


</script>
</body>
</html>
